<div class="ntmc-container">
  <!-- Left: 3D Viewport -->
  <div class="ntmc-viewport-container">
    <div #viewport class="ntmc-viewport"></div>

    <!-- Loading overlay -->
    @if (showLoadingOverlay() && service.isLoading()) {
      <div class="ntmc-loading-overlay">
        <div class="ntmc-spinner" [style.border-top-color]="spinnerColor()"></div>
        @if (showLoadingProgress()) {
          <div class="ntmc-progress-container">
            <span class="ntmc-progress-text">{{ service.loadingProgress().percentage }}%</span>
            <div class="ntmc-progress-bar">
              <div
                class="ntmc-progress-fill"
                [style.width.%]="service.loadingProgress().percentage"
                [style.background-color]="spinnerColor()"
              ></div>
            </div>
          </div>
        }
        <span>{{ labels().loadingLabel }}</span>
      </div>
    }

    <!-- Error overlay -->
    @if (showErrorOverlay() && service.hasError()) {
      <div class="ntmc-error-overlay">
        <span class="ntmc-error-icon">⚠️</span>
        <span>{{ labels().errorLabel }}: {{ service.errorMessage() }}</span>
      </div>
    }
  </div>

  <!-- Right: UI Panel -->
  <div class="ntmc-ui-panel">
    @if (uiTemplate()) {
      <!-- Custom template -->
      <ng-container
        [ngTemplateOutlet]="uiTemplate()!"
        [ngTemplateOutletContext]="{ $implicit: uiContext() }"
      ></ng-container>
    } @else {
      <!-- Default UI -->
      <div class="ntmc-default-ui">
        <!-- Crop Box Section -->
        <section class="ntmc-section">
          <h3>{{ labels().cropBoxTitle }}</h3>

          <div class="ntmc-checkbox-row">
            <label>
              <input
                type="checkbox"
                [checked]="service.boxVisible()"
                (change)="onBoxVisibilityChange($event)"
              />
              {{ labels().boxVisibleLabel }}
            </label>
          </div>

          <div class="ntmc-input-row">
            <label for="ntmc-box-color">{{ labels().boxColorLabel }}</label>
            <input
              id="ntmc-box-color"
              type="color"
              [value]="service.cropBoxColor()"
              (input)="onCropBoxColorChange($event)"
            />
          </div>

          <div class="ntmc-checkbox-row ntmc-checkbox-inline">
            <label>
              <input
                type="checkbox"
                [checked]="service.gridVisible()"
                (change)="onGridVisibilityChange($event)"
              />
              {{ labels().gridVisibleLabel }}
            </label>
          </div>

          <div class="ntmc-checkbox-row ntmc-checkbox-inline">
            <label>
              <input
                type="checkbox"
                [checked]="service.viewHelperVisible()"
                (change)="onViewHelperVisibilityChange($event)"
              />
              {{ labels().viewHelperVisibleLabel }}
            </label>
          </div>

          <div class="ntmc-input-grid">
            <div class="ntmc-input-row">
              <label for="ntmc-minX">{{ labels().minXLabel }}</label>
              <input
                id="ntmc-minX"
                type="number"
                step="0.1"
                [value]="service.cropBox().minX"
                (input)="onCropBoxChange('minX', $event)"
              />
            </div>
            <div class="ntmc-input-row">
              <label for="ntmc-maxX">{{ labels().maxXLabel }}</label>
              <input
                id="ntmc-maxX"
                type="number"
                step="0.1"
                [value]="service.cropBox().maxX"
                (input)="onCropBoxChange('maxX', $event)"
              />
            </div>
            <div class="ntmc-input-row">
              <label for="ntmc-minY">{{ labels().minYLabel }}</label>
              <input
                id="ntmc-minY"
                type="number"
                step="0.1"
                [value]="service.cropBox().minY"
                (input)="onCropBoxChange('minY', $event)"
              />
            </div>
            <div class="ntmc-input-row">
              <label for="ntmc-maxY">{{ labels().maxYLabel }}</label>
              <input
                id="ntmc-maxY"
                type="number"
                step="0.1"
                [value]="service.cropBox().maxY"
                (input)="onCropBoxChange('maxY', $event)"
              />
            </div>
            <div class="ntmc-input-row">
              <label for="ntmc-minZ">{{ labels().minZLabel }}</label>
              <input
                id="ntmc-minZ"
                type="number"
                step="0.1"
                [value]="service.cropBox().minZ"
                (input)="onCropBoxChange('minZ', $event)"
              />
            </div>
            <div class="ntmc-input-row">
              <label for="ntmc-maxZ">{{ labels().maxZLabel }}</label>
              <input
                id="ntmc-maxZ"
                type="number"
                step="0.1"
                [value]="service.cropBox().maxZ"
                (input)="onCropBoxChange('maxZ', $event)"
              />
            </div>
          </div>
        </section>

        <!-- Transform Section -->
        <section class="ntmc-section">
          <h3>{{ labels().transformTitle }}</h3>

          <!-- Position -->
          <div class="ntmc-subsection">
            <h4>{{ labels().positionLabel }}</h4>
            <div class="ntmc-input-grid ntmc-input-grid-3">
              <div class="ntmc-input-row">
                <label for="ntmc-posX">X</label>
                <input
                  id="ntmc-posX"
                  type="number"
                  step="0.1"
                  [value]="service.meshTransform().position.x"
                  (input)="onPositionChange('x', $event)"
                />
              </div>
              <div class="ntmc-input-row">
                <label for="ntmc-posY">Y</label>
                <input
                  id="ntmc-posY"
                  type="number"
                  step="0.1"
                  [value]="service.meshTransform().position.y"
                  (input)="onPositionChange('y', $event)"
                />
              </div>
              <div class="ntmc-input-row">
                <label for="ntmc-posZ">Z</label>
                <input
                  id="ntmc-posZ"
                  type="number"
                  step="0.1"
                  [value]="service.meshTransform().position.z"
                  (input)="onPositionChange('z', $event)"
                />
              </div>
            </div>
          </div>

          <!-- Rotation -->
          <div class="ntmc-subsection">
            <h4>{{ labels().rotationLabel }}</h4>
            <div class="ntmc-input-grid ntmc-input-grid-3">
              <div class="ntmc-input-row">
                <label for="ntmc-rotX">X</label>
                <input
                  id="ntmc-rotX"
                  type="number"
                  step="0.1"
                  [value]="service.meshTransform().rotation.x"
                  (input)="onRotationChange('x', $event)"
                />
              </div>
              <div class="ntmc-input-row">
                <label for="ntmc-rotY">Y</label>
                <input
                  id="ntmc-rotY"
                  type="number"
                  step="0.1"
                  [value]="service.meshTransform().rotation.y"
                  (input)="onRotationChange('y', $event)"
                />
              </div>
              <div class="ntmc-input-row">
                <label for="ntmc-rotZ">Z</label>
                <input
                  id="ntmc-rotZ"
                  type="number"
                  step="0.1"
                  [value]="service.meshTransform().rotation.z"
                  (input)="onRotationChange('z', $event)"
                />
              </div>
            </div>
          </div>
        </section>

        <!-- Actions -->
        <section class="ntmc-section ntmc-actions">
          <button
            class="ntmc-btn ntmc-btn-primary"
            [disabled]="!service.canApplyCrop()"
            (click)="onApplyCrop()"
          >
            {{ labels().applyCropLabel }}
          </button>
          <button
            class="ntmc-btn ntmc-btn-secondary"
            [disabled]="!service.canExport()"
            (click)="onDownload()"
          >
            {{ labels().downloadLabel }}
          </button>
        </section>
      </div>
    }

    <!-- Content projection slot -->
    <ng-content></ng-content>
  </div>
</div>
